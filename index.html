<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; background: transparent; overflow: hidden; }
        #wrvo-alert-widget { font-family: 'Roboto', sans-serif; border: 1px solid #ddd; border-top: 4px solid #005596; border-radius: 4px; background: #fff; }
        .wrvo-header { background: #f8f9fa; padding: 10px 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .wrvo-ticker-wrap { width: 100%; overflow: hidden; background: #fff; min-height: 50px; display: flex; align-items: center; }
        .wrvo-marquee { display: flex; white-space: nowrap; animation: wrvo-scroll 45s linear infinite; padding-left: 100%; }
        @keyframes wrvo-scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        .wrvo-alert-item { display: inline-block; padding: 0 50px; font-size: 1.1em; color: #d32f2f; font-weight: 700; text-decoration: none; }
        .wrvo-status { padding: 15px; font-size: 0.9em; color: #444; }
        #wrvo-ts { font-weight: bold; }
    </style>
</head>
<body>
    <div id="wrvo-alert-widget">
        <div class="wrvo-header">
            <span style="font-weight: 700; color: #333; font-size: 0.85em; text-transform: uppercase; letter-spacing: 0.5px;">Regional Weather Alerts</span>
            <span id="wrvo-dot" style="height: 8px; width: 8px; background-color: #bbb; border-radius: 50%;"></span>
        </div>
        <div id="wrvo-content" class="wrvo-ticker-wrap">
            <div class="wrvo-status" id="wrvo-msg">Fetching latest NWS data...</div>
        </div>
        <div style="background: #f8f9fa; padding: 5px 15px; font-size: 0.65em; color: #999; border-top: 1px solid #eee; text-align: right;">
            NWS Live Feed | Updated: <span id="wrvo-ts">--:--</span>
        </div>
    </div>

    <script>
        (function() {
            const counties = ["Onondaga", "Oswego", "Jefferson", "Lewis", "St. Lawrence", "Franklin", "Hamilton", "Oneida", "Herkimer", "Otsego", "Chenango", "Madison", "Cortland", "Cayuga", "Seneca", "Wayne", "Ontario", "Yates", "Schuyler", "Tompkins", "Tioga", "Broome"];

            async function checkAlerts() {
                const dot = document.getElementById('wrvo-dot');
                const ts = document.getElementById('wrvo-ts');
                const content = document.getElementById('wrvo-content');

                try {
                    // Direct fetch to NWS with required headers
                    const response = await fetch('https://api.weather.gov/alerts/active?area=NY', {
                        headers: { 
                            'Accept': 'application/geo+json',
                            'User-Agent': '(wrvo.org, news@wrvo.org)' 
                        }
                    });

                    if (!response.ok) throw new Error('Network response was not ok');
                    
                    const data = await response.json();
                    
                    // Filter alerts by WRVO counties
                    const local = data.features.filter(a => {
                        const desc = a.properties.areaDesc || "";
                        return counties.some(c => desc.includes(c));
                    });

                    ts.innerText = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                    if (local.length === 0) {
                        dot.style.backgroundColor = "#2ecc71"; // Green for safe
                        content.innerHTML = '<div class="wrvo-status">✓ No active weather alerts for the WRVO region.</div>';
                    } else {
                        dot.style.backgroundColor = "#e74c3c"; // Red for alert
                        
                        // Create alert items
                        const alertHtml = local.map(a => `
                            <a class="wrvo-alert-item" href="https://www.weather.gov" target="_blank">
                                ⚠️ ${a.properties.event.toUpperCase()}: ${a.properties.areaDesc}
                            </a>
                        `).join('');

                        // Use marquee only if there are multiple alerts
                        if (local.length === 1) {
                            content.innerHTML = `<div style="padding:15px;">${alertHtml}</div>`;
                        } else {
                            content.innerHTML = `<div class="wrvo-marquee">${alertHtml}${alertHtml}</div>`;
                        }
                    }
                } catch (err) {
                    console.error('Weather Widget Error:', err);
                    dot.style.backgroundColor = "#bbb";
                    content.innerHTML = '<div class="wrvo-status" style="color:#888;">Live data temporarily unavailable. <a href="https://www.weather.gov" target="_blank" style="color:#005596">Check Weather.gov</a></div>';
                }
            }

            checkAlerts();
            setInterval(checkAlerts, 300000); // Refresh every 5 minutes
        })();
    </script>
</body>
</html>
